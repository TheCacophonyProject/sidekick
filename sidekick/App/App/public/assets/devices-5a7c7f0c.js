import{I as W,d as G,R as Z,a as f,b as ee,e as w,f as P,i as a,c as i,F as te,g as ne,t as y,h as ie,j as se,B as oe,k as ae,l as L,m as j,n as K,p as ce,q as le,o as re,G as de,r as H,s as ue,v as ve,D as fe}from"./index-33b209e3.js";import{A as ge}from"./ActionContainer-7b05aa46.js";import{D as p}from"./index-0836cc50.js";import{C as he}from"./CircleButton-7bf58bb2.js";function me(e){return W({a:{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",viewBox:"0 0 24 24"},c:'<path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="8"/><path d="M12 2v2M12 20v2M20 12h2M2 12h2"/>'},e)}function be(e){return W({a:{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",viewBox:"0 0 24 24"},c:'<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>'},e)}const $e=y("<button></button>",2),xe=y('<div class="flex items-center justify-between px-2"><div role="button"><h1 class="break-all text-left text-lg"></h1><div class="mt-2 flex w-full items-center space-x-2 text-slate-700"><p class="text-sm">Recordings Saved: <!>/<!> </p></div><div class="mt-2 flex w-full items-center space-x-2 text-slate-700"><p class="text-sm">Events Saved: <!>/<!> </p></div></div><div class="flex items-center space-x-6 px-2 text-blue-500"><button class="text-blue-500"></button></div></div>',22),V=y('<button class="text-blue-500"></button>',2),we=y('<div class="text-yellow-400"></div>',2),ye=y('<section class="pb-bar pt-bar relative h-full space-y-2 overflow-y-auto bg-gray-200 px-2"><div class="h-32 bg-gray-200"></div><div class="pb-bar fixed inset-x-0 bottom-[4vh] mx-auto flex justify-center"></div></section>',6);function De(e){const s=G(),m=ie(),[D,k]=f([]),[b,R]=f([]),[$,l]=f([]),[n,o]=f([]),[r,d]=f(!1),[h,g]=f(!1);w(()=>{const t=b().length>0&&b().length!==D().length,c=n().length>0&&$().length!==n().length;g(!t&&!c)}),w(()=>{const t=m.SavedEvents().filter(v=>v.device===e.device.id&&!v.isUploaded),c=[...s.deviceEventKeys.get(e.device.id)??[]];l(t),o(c)}),w(()=>{const t=m.SavedRecordings().filter(v=>v.device===e.device.id&&!v.isUploaded),c=[...s.deviceRecordings.get(e.device.id)??[]];k(t),R(c)});const M=t=>{t.isConnected&&ve.open({url:t.url})},q=async t=>{const{value:c}=await p.confirm({title:"Confirm",message:`Are you sure you want to set device ${t.name} to your current location?`});c&&t.isConnected&&await s?.setDeviceToCurrLocation(t)},O=async t=>{const{value:c}=await p.confirm({title:"Confirm",message:`Are you sure you want to download all recordings and events from ${t.name}?`});c&&t.isConnected&&(d(!0),await Promise.all([s.saveRecordings(t),s.saveEvents(t)]),d(!1))};return i(ge,{get action(){return(()=>{const t=V.cloneNode(!0);return t.$$click=()=>M(e.device),a(t,i(se,{size:32})),t})()},get children(){const t=xe.cloneNode(!0),c=t.firstChild,v=c.firstChild,E=v.nextSibling,S=E.firstChild,J=S.firstChild,T=J.nextSibling,Q=T.nextSibling,B=Q.nextSibling;B.nextSibling;const U=E.nextSibling,_=U.firstChild,X=_.firstChild,z=X.nextSibling,Y=z.nextSibling,A=Y.nextSibling;A.nextSibling;const N=c.nextSibling,C=N.firstChild;return c.$$click=()=>M(e.device),a(v,()=>e.device.name),a(E,i(oe,{size:20}),S),a(S,()=>D().length,T),a(S,()=>b().length,B),a(U,i(ae,{size:20}),_),a(_,()=>m.SavedEvents().filter(u=>u.device===e.device.id).length,z),a(_,()=>s.deviceEventKeys.get(e.device.id)?.length??0,A),a(N,i(L,{get when(){return!r()},get fallback(){return i(j,{size:28,class:"animate-spin"})},get children(){const u=$e.cloneNode(!0);return u.$$click=()=>O(e.device),a(u,i(be,{size:28})),K(x=>{const F=`${h()?"text-slate-300":"text-blue-500"}`,I=h();return F!==x._v$&&ce(u,x._v$=F),I!==x._v$2&&(u.disabled=x._v$2=I),x},{_v$:void 0,_v$2:void 0}),u}}),C),C.$$click=()=>q(e.device),a(C,i(L,{get when(){return!s.locationBeingSet.has(e.device.id)},get fallback(){return i(j,{size:28,class:"animate-spin"})},get children(){return i(L,{get when(){return!e.shouldUpdateLocation},get fallback(){return(()=>{const u=we.cloneNode(!0);return a(u,i(me,{size:28})),u})()},get children(){return i(le,{size:28})}})}})),K(()=>C.disabled=s.locationBeingSet.has(e.device.id)),t}})}function ke(){const e=G(),s=new Z,[m,D]=f(),[k,b]=f(!1),R=async()=>{const{value:l}=await p.confirm({title:"Connecting to Offline Device",message:`Please ensure you have reset the device and have waited atleast a few minutes for bootup. Alternatively: connect to the device's wifi "bushnet" password "feathers" when available`});l&&await fe.connectToDeviceAP()},$=()=>{e.startDiscovery(),setTimeout(()=>{e.stopDiscovery()},5e3)};return ee(async()=>{$();const l=setInterval(()=>{$()},60*1e3*1);re(()=>{clearInterval(l)}),D(await de.getCurrentPosition({enableHighAccuracy:!0}));const n=H.get("/devices");n&&H.set("/devices",[n[0],(()=>{const o=V.cloneNode(!0);return o.$$click=R,a(o,i(ue,{size:28})),o})()])}),w(()=>{const l=e.devices.values();P(async()=>{for(const n of l){if(!n.isConnected)return;const o=await e.getLocation(n);if(o.success){const r=o.data,d=m();if(!d)return s.delete(n.id);const h=Math.abs(r.latitude-d.coords.latitude),g=Math.abs(r.longitude-d.coords.longitude);h>.001||g>.001?s.add(n.id):s.delete(n.id)}}})}),w(()=>{if(e.isDiscovering())return;const n=s.values();P(async()=>{const o=[...n].filter(d=>!e.locationBeingSet.has(d));if(o.length>0&&!k()){const d=o.length===1?`${e.devices.get(o[0])?.name} has a different location stored. Would you like to update it to your current location?`:`${o.join(", ")} have different location stored. Would you like to update them to the current location?`,{value:h}=await p.confirm({title:"Update Location",message:d});if(h)for(const g of e.devices.values())s.has(g.id)&&g.isConnected&&await e.setDeviceToCurrLocation(g);else b(!0)}}),e.isDiscovering()}),(()=>{const l=ye.cloneNode(!0),n=l.firstChild,o=n.nextSibling;return a(l,i(te,{get each(){return[...e.devices.values()].filter(r=>r.isConnected)},children:r=>r&&i(De,{device:r,get shouldUpdateLocation(){return s.has(r.id)}})}),n),a(o,i(he,{onClick:$,get disabled(){return e.isDiscovering()},get loading(){return e.isDiscovering()},text:"Search Devices",loadingText:"Searching..."})),l})()}ne(["click"]);export{ke as default};
